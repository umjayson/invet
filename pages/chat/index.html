<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invet Chat Interface</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        purple: {
                            950: '#2D1A45',
                            900: '#3B2057',
                            600: '#7E3AF2',
                            400: '#A78BFA',
                            300: '#C4B5FD',
                            200: '#DDD6FE'
                        },
                        indigo: {
                            950: '#1E1B4B',
                            600: '#4F46E5',
                            400: '#818CF8',
                            300: '#A5B4FC'
                        },
                        green: {
                            600: '#059669',
                            500: '#10B981',
                            400: '#34D399'
                        },
                        teal: {
                            400: '#2DD4BF'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Additional custom styles */
        .backdrop-blur-md {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        .scrollbar-thin {
            scrollbar-width: thin;
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-purple-950 via-purple-900 to-indigo-950 flex flex-col">
    <!-- Chat Header -->
    <header class="bg-white/10 backdrop-blur-md border-b border-white/10">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="h-10 w-10 rounded-lg bg-gradient-to-tr from-green-600 to-teal-400 flex items-center justify-center">
                        <span class="text-sm font-bold text-white">I</span>
                    </div>
                    <h1 class="text-xl font-bold text-white">Invet Chat</h1>
                </div>
                <div class="flex items-center gap-4">
                    <div id="role-specific-links">
                        <!-- Role-specific links will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Chat Interface -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Chat Sidebar -->
        <div class="w-80 bg-white/5 backdrop-blur-sm border-r border-white/10 flex flex-col">
            <!-- User Info -->
            <div class="p-4 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-indigo-600 flex items-center justify-center">
                        <span id="user-initial" class="text-sm font-bold text-white">U</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-white font-medium truncate">User</p>
                        <p id="user-email" class="text-purple-300 text-sm truncate">user@example.com</p>
                    </div>
                </div>
            </div>

            <!-- Chat Search -->
            <div class="p-4 border-b border-white/10">
                <div class="relative">
                    <input
                        type="text"
                        placeholder="Search chats..."
                        class="w-full bg-white/10 border border-white/20 rounded-md py-2 px-4 pl-10 text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500"
                    />
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-purple-300"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                </div>
            </div>

            <!-- New Chat Button -->
            <div class="p-4">
                <button
                    id="new-chat-btn"
                    class="w-full bg-green-600 hover:bg-green-500 text-white rounded-md py-2 px-4 flex items-center justify-center gap-2 transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M12 5v14"></path>
                        <path d="M5 12h14"></path>
                    </svg>
                    New Chat
                </button>
            </div>

            <!-- Chat List -->
            <div id="chat-list" class="flex-1 overflow-y-auto scrollbar-thin">
                <!-- Loading state -->
                <div id="chats-loading" class="flex items-center justify-center h-full">
                    <svg
                        class="animate-spin h-8 w-8 text-purple-400"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                    >
                        <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"
                        ></circle>
                        <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                    </svg>
                </div>

                <!-- Empty state -->
                <div id="chats-empty" class="flex flex-col items-center justify-center h-full p-4 text-center hidden">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-12 w-12 text-purple-400 mb-4"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p class="text-purple-200 mb-4">No chats found</p>
                    <button
                        id="empty-new-chat-btn"
                        class="bg-green-600 hover:bg-green-500 text-white rounded-md py-2 px-4 text-sm transition-colors"
                    >
                        Start a New Chat
                    </button>
                </div>

                <!-- Chat list items will be inserted here -->
                <div id="chats-container" class="divide-y divide-white/5 hidden"></div>
            </div>
        </div>

        <!-- Chat Main Area -->
        <div class="flex-1 flex flex-col">
            <!-- No active chat state -->
            <div id="no-active-chat" class="flex-1 flex flex-col items-center justify-center p-4 text-center">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-16 w-16 text-purple-400 mb-4"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-white mb-2">Welcome to Invet Chat</h2>
                <p class="text-purple-200 max-w-md mb-6">
                    Select an existing chat from the sidebar or create a new one to get started.
                </p>
                <button
                    id="welcome-new-chat-btn"
                    class="bg-green-600 hover:bg-green-500 text-white rounded-md py-2 px-6 transition-colors"
                >
                    Start a New Chat
                </button>
            </div>

            <!-- Active chat content -->
            <div id="active-chat" class="flex-1 flex flex-col hidden">
                <!-- Chat Header -->
                <div class="p-4 border-b border-white/10 bg-white/5 backdrop-blur-sm">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-indigo-600/20 flex items-center justify-center">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 text-indigo-400"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 id="active-chat-title" class="text-white font-medium">Chat Title</h2>
                                <p id="active-chat-participants" class="text-purple-300 text-sm">0 participants</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="p-2 rounded-full hover:bg-white/10 text-purple-300 hover:text-white transition-colors">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="19" cy="12" r="1"></circle>
                                    <circle cx="5" cy="12" r="1"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Error message -->
                <div id="chat-error" class="p-2 bg-red-500/20 text-white border border-red-500/30 m-4 rounded-md hidden">
                    <div class="flex items-center">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 mr-2 flex-shrink-0"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <span id="error-message">An error occurred</span>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin">
                    <!-- Messages will be inserted here -->
                    
                    <!-- Empty messages state -->
                    <div id="empty-messages" class="flex flex-col items-center justify-center h-full text-center">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-12 w-12 text-purple-400 mb-4"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p class="text-purple-200">No messages yet</p>
                        <p class="text-purple-300 text-sm mt-2">Start the conversation!</p>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="p-4 border-t border-white/10 bg-white/5 backdrop-blur-sm">
                    <form id="message-form" class="flex items-center gap-2">
                        <input
                            id="message-input"
                            type="text"
                            placeholder="Type a message..."
                            class="flex-1 bg-white/10 border border-white/20 rounded-md py-2 px-4 text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-green-500"
                        />
                        <button
                            type="submit"
                            id="send-button"
                            class="p-2 bg-green-600 hover:bg-green-500 text-white rounded-md transition-colors"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <path d="m22 2-7 20-4-9-9-4Z"></path>
                                <path d="M22 2 11 13"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global state
        let currentUser = null;
        let userRole = null;
        let userData = null;
        let teamData = null;
        let chats = [];
        let activeChat = null;
        let messages = [];
        let messageListeners = {};
        let chatListener = null;

        // DOM elements
        const userInitial = document.getElementById('user-initial');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const roleSpecificLinks = document.getElementById('role-specific-links');
        const newChatBtn = document.getElementById('new-chat-btn');
        const emptyChatBtn = document.getElementById('empty-new-chat-btn');
        const welcomeNewChatBtn = document.getElementById('welcome-new-chat-btn');
        const chatsLoading = document.getElementById('chats-loading');
        const chatsEmpty = document.getElementById('chats-empty');
        const chatsContainer = document.getElementById('chats-container');
        const noActiveChat = document.getElementById('no-active-chat');
        const activeChatelement = document.getElementById('active-chat');
        const activeChatTitle = document.getElementById('active-chat-title');
        const activeChatParticipants = document.getElementById('active-chat-participants');
        const chatError = document.getElementById('chat-error');
        const errorMessage = document.getElementById('error-message');
        const messagesContainer = document.getElementById('messages-container');
        const emptyMessages = document.getElementById('empty-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // Check authentication state
        auth.onAuthStateChanged(async function(user) {
            if (user) {
                // User is signed in
                currentUser = user;
                userEmail.textContent = user.email;
                
                try {
                    // Fetch user data
                    await fetchUserData();
                    
                    // Fetch chats
                    fetchChats();
                } catch (error) {
                    console.error("Error initializing chat:", error);
                    showError("Failed to load chat data. Please refresh the page.");
                }
            } else {
                // User is signed out, redirect to login
                window.location.href = '/login.html';
            }
        });

        // Fetch user data
        async function fetchUserData() {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            
            if (userDoc.exists) {
                userData = userDoc.data();
                userRole = userData.role;
                
                // Update UI with user data
                userName.textContent = userData.name || 'User';
                userInitial.textContent = (userData.name?.charAt(0) || currentUser.email?.charAt(0) || 'U').toUpperCase();
                
                // Add role-specific links
                if (userRole === 'admin') {
                    roleSpecificLinks.innerHTML = `
                        <a href="/admin/dashboard" class="px-4 py-2 bg-purple-700 hover:bg-purple-600 text-white rounded-md text-sm font-medium transition-colors">
                            Admin Dashboard
                        </a>
                    `;
                } else if (userRole === 'team') {
                    roleSpecificLinks.innerHTML = `
                        <a href="/team/dashboard" class="px-4 py-2 bg-indigo-700 hover:bg-indigo-600 text-white rounded-md text-sm font-medium transition-colors">
                            Team Dashboard
                        </a>
                    `;
                }
                
                // If user is part of a team, fetch team data
                if (userData.teamId) {
                    const teamDoc = await db.collection('teams').doc(userData.teamId).get();
                    if (teamDoc.exists) {
                        teamData = teamDoc.data();
                    }
                }
            } else {
                throw new Error("User data not found");
            }
        }

        // Fetch chats
        function fetchChats() {
            // Clear previous listener
            if (chatListener) {
                chatListener();
            }
            
            let chatsQuery;
            
            if (userRole === 'admin') {
                // Admins can see all chats
                chatsQuery = db.collection('chats').orderBy('updatedAt', 'desc');
            } else if (userRole === 'team') {
                // Team owners see their team's chats
                chatsQuery = db.collection('chats').where('teamId', '==', currentUser.uid).orderBy('updatedAt', 'desc');
            } else {
                // Employees see chats they're participants in
                chatsQuery = db.collection('chats').where('participants', 'array-contains', currentUser.uid).orderBy('updatedAt', 'desc');
            }
            
            chatListener = chatsQuery.onSnapshot((snapshot) => {
                chats = snapshot.docs.map((doc) => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update UI
                updateChatsList();
                
                // If no active chat is selected and we have chats, select the first one
                if (!activeChat && chats.length > 0) {
                    selectChat(chats[0]);
                }
            }, (error) => {
                console.error("Error fetching chats:", error);
                showError("Failed to load chats. Please refresh the page.");
            });
        }

        // Update chats list in UI
        function updateChatsList() {
            // Hide loading state
            chatsLoading.classList.add('hidden');
            
            if (chats.length > 0) {
                // Show chats container
                chatsContainer.classList.remove('hidden');
                chatsEmpty.classList.add('hidden');
                
                // Generate chat list HTML
                let chatsHTML = '';
                
                chats.forEach((chat) => {
                    const isActive = activeChat && activeChat.id === chat.id;
                    const updatedTime = chat.updatedAt ? new Date(chat.updatedAt.seconds * 1000).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';
                    
                    chatsHTML += `
                        <div 
                            class="p-4 cursor-pointer hover:bg-white/10 transition-colors ${isActive ? 'bg-white/10' : ''}"
                            data-chat-id="${chat.id}"
                        >
                            <div class="flex items-center gap-3">
                                <div class="h-10 w-10 rounded-full bg-indigo-600/20 flex items-center justify-center">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5 text-indigo-400"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    >
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-white font-medium truncate">${chat.title || 'Unnamed Chat'}</p>
                                    <p class="text-purple-300 text-sm truncate">
                                        ${chat.teamName ? `Team: ${chat.teamName}` : 'Personal Chat'}
                                    </p>
                                </div>
                                <div class="text-xs text-purple-300">
                                    ${updatedTime}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                chatsContainer.innerHTML = chatsHTML;
                
                // Add click event listeners to chat items
                document.querySelectorAll('[data-chat-id]').forEach(chatItem => {
                    chatItem.addEventListener('click', () => {
                        const chatId = chatItem.getAttribute('data-chat-id');
                        const chat = chats.find(c => c.id === chatId);
                        if (chat) {
                            selectChat(chat);
                        }
                    });
                });
            } else {
                // Show empty state
                chatsContainer.classList.add('hidden');
                chatsEmpty.classList.remove('hidden');
            }
        }

        // Select a chat
        function selectChat(chat) {
            // Update active chat
            activeChat = chat;
            
            // Update UI
            updateChatsList();
            
            // Show active chat UI
            noActiveChat.classList.add('hidden');
            activeChatelement.classList.remove('hidden');
            
            // Update chat header
            activeChatTitle.textContent = chat.title || 'Unnamed Chat';
            activeChatParticipants.textContent = `${chat.participants?.length || 0} participants`;
            
            // Fetch messages
            fetchMessages(chat.id);
        }

        // Fetch messages for a chat
        function fetchMessages(chatId) {
            // Clear previous messages
            messages = [];
            updateMessagesUI();
            
            // Clear previous listener
            if (messageListeners[chatId]) {
                messageListeners[chatId]();
                delete messageListeners[chatId];
            }
            
            // Set up new listener
            const messagesQuery = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc');
            
            messageListeners[chatId] = messagesQuery.onSnapshot((snapshot) => {
                messages = snapshot.docs.map((doc) => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update UI
                updateMessagesUI();
                
                // Scroll to bottom
                scrollToBottom();
            }, (error) => {
                console.error("Error fetching messages:", error);
                showError("Failed to load messages. Please refresh the page.");
            });
        }

        // Update messages UI
        function updateMessagesUI() {
            if (messages.length > 0) {
                // Hide empty state
                emptyMessages.classList.add('hidden');
                
                // Generate messages HTML
                let messagesHTML = '';
                
                messages.forEach((message) => {
                    const isCurrentUser = message.senderId === currentUser.uid;
                    const messageTime = message.timestamp ? new Date(message.timestamp.seconds * 1000).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';
                    
                    messagesHTML += `
                        <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[70%] rounded-lg p-3 ${
                                isCurrentUser ? 'bg-green-600 text-white' : 'bg-white/10 text-white'
                            }">
                                ${!isCurrentUser ? `<p class="text-xs font-medium mb-1 text-purple-200">${message.senderName || 'User'}</p>` : ''}
                                <p>${message.text}</p>
                                <p class="text-xs mt-1 text-right opacity-70">${messageTime}</p>
                            </div>
                        </div>
                    `;
                });
                
                messagesContainer.innerHTML = messagesHTML;
            } else {
                // Show empty state
                emptyMessages.classList.remove('hidden');
                messagesContainer.innerHTML = '';
            }
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            chatError.classList.remove('hidden');
            
            // Hide error after 5 seconds
            setTimeout(() => {
                chatError.classList.add('hidden');
            }, 5000);
        }

        // Create new chat
        async function createNewChat() {
            // Update UI to show creating state
            newChatBtn.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Creating...
            `;
            emptyChatBtn.disabled = true;
            welcomeNewChatBtn.disabled = true;
            
            try {
                // Create a new chat document
                const chatData = {
                    title: `New Chat - ${new Date().toLocaleString()}`,
                    type: 'individual',
                    participants: [currentUser.uid],
                    createdAt: firebase.firestore.Timestamp.now(),
                    updatedAt: firebase.firestore.Timestamp.now(),
                };
                
                // If user is part of a team, add team info
                if (userData?.teamId) {
                    chatData.teamId = userData.teamId;
                    chatData.teamName = userData.teamName;
                }
                
                // Add the new chat to Firestore
                const newChatRef = await db.collection('chats').add(chatData);
                
                // Add a welcome message
                await db.collection('chats').doc(newChatRef.id).collection('messages').add({
                    text: 'Welcome to your new chat! Start typing to send messages.',
                    senderId: 'system',
                    senderName: 'System',
                    timestamp: firebase.firestore.Timestamp.now(),
                    type: 'notification',
                });
                
                // The chat will be selected automatically when the chats list updates
            } catch (error) {
                console.error("Error creating new chat:", error);
                showError("Failed to create new chat. Please try again.");
                
                // Reset UI
                newChatBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14"></path>
                        <path d="M5 12h14"></path>
                    </svg>
                    New Chat
                `;
                emptyChatBtn.disabled = false;
                welcomeNewChatBtn.disabled = false;
            }
        }

        // Send message
        async function sendMessage(e) {
            e.preventDefault();
            
            const messageText = messageInput.value.trim();
            if (!messageText || !activeChat) return;
            
            // Update UI to show sending state
            sendButton.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            `;
            sendButton.disabled = true;
            
            try {
                const messageData = {
                    text: messageText,
                    senderId: currentUser.uid,
                    senderName: userData?.name || 'User',
                    timestamp: firebase.firestore.Timestamp.now(),
                };
                
                // Add message to subcollection
                await db.collection('chats').doc(activeChat.id).collection('messages').add(messageData);
                
                // Update chat's updatedAt timestamp
                await db.collection('chats').doc(activeChat.id).update({
                    updatedAt: firebase.firestore.Timestamp.now(),
                    lastMessage: messageText.substring(0, 50) + (messageText.length > 50 ? '...' : ''),
                    lastMessageTime: firebase.firestore.Timestamp.now(),
                    lastMessageSender: userData?.name || 'User',
                });
                
                // Clear input
                messageInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showError("Failed to send message. Please try again.");
            } finally {
                // Reset UI
                sendButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m22 2-7 20-4-9-9-4Z"></path>
                        <path d="M22 2 11 13"></path>
                    </svg>
                `;
                sendButton.disabled = false;
            }
        }

        // Event listeners
        newChatBtn.addEventListener('click', createNewChat);
        emptyChatBtn.addEventListener('click', createNewChat);
        welcomeNewChatBtn.addEventListener('click', createNewChat);
        messageForm.addEventListener('submit', sendMessage);

        // Cleanup function for page unload
        window.addEventListener('beforeunload', () => {
            // Clear all listeners
            if (chatListener) {
                chatListener();
            }
            
            Object.values(messageListeners).forEach(listener => {
                if (listener) {
                    listener();
                }
            });
        });
    </script>
</body>
</html>

I've completed the HTML file with the JavaScript code that was cut off. This chat interface includes:

1. A responsive layout with a sidebar for chat selection and a main area for messages
2. Firebase integration for authentication, Firestore data fetching, and real-time updates
3. Role-based access with different views for admin, team, and employee users
4. Functionality to create new chats and send messages
5. Real-time message updates with proper loading and error states
6. A clean UI with a purple/green gradient theme and glassmorphism effects

To use this page, you'll need to:
1. Replace the Firebase configuration with your actual Firebase project details
2. Ensure your Firestore has the appropriate collections (users, teams, chats)
3. Make sure your authentication system is properly set up

